<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>NYC Fleet EV Map (Live via GitHub CSV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }

    .legend, .controls {
      background: white;
      padding: 8px 10px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      font: 14px/1.2 system-ui, -apple-system, Arial, sans-serif;
    }
    .legend .row {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      gap: 6px;
    }
    .swatch {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 2px;
      border: 1px solid #3333;
    }
    .legend .label { flex: 1; }
    .legend .count { color: #6b7280; }
    .controls label { display: block; margin: 3px 0; }

    .bolt-circle {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #222;
      color: #fff;
      font-size: 16px;
      line-height: 1;
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
      transform: translate(-1px, -1px);
    }

    /* COLORS BY CHARGER TYPE / SOURCE */
    .bolt-l3 { background: #16a34a; }
    .bolt-l2 { background: #2563eb; }
    .bolt-solar { background: #facc15; color: #111; }
    .bolt-public { background: #f97316; }
    .bolt-flo { background: #a855f7; }
    .bolt-dotlot { background: #6b7280; }

    .leaflet-div-icon { background: transparent; border: none; }

    /* ======================
       NEW: Address search / location UI
       ====================== */
    .search-ctl {
      background: white;
      padding: 8px 10px;
      border-radius: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      font: 13px/1.2 system-ui, -apple-system, Arial, sans-serif;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .search-ctl input {
      width: 240px;
      max-width: 60vw;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      outline: none;
      font-size: 13px;
    }
    .search-ctl button {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #111;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    .search-ctl button.secondary {
      background: #fff;
      color: #111;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    var map = L.map('map').setView([40.7128, -74.0060], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ======================
    // NEW: USER LOCATION + ADDRESS SEARCH (SAFE / ISOLATED)
    // ======================
    var userLocationLayer = L.layerGroup().addTo(map);

    function clearUserLocation() {
      userLocationLayer.clearLayers();
    }

    function setUserLocation(lat, lon, label, accuracyMeters) {
      clearUserLocation();

      var marker = L.marker([lat, lon]).addTo(userLocationLayer);
      marker.bindPopup(label || 'Selected location').openPopup();

      if (typeof accuracyMeters === 'number' && isFinite(accuracyMeters) && accuracyMeters > 0) {
        L.circle([lat, lon], { radius: accuracyMeters }).addTo(userLocationLayer);
      }

      map.setView([lat, lon], 14);
    }

    function locateMeSafe() {
      try {
        if (!navigator.geolocation) {
          alert("Geolocation isn't supported by this browser.");
          return;
        }
        navigator.geolocation.getCurrentPosition(
          function(pos) {
            setUserLocation(
              pos.coords.latitude,
              pos.coords.longitude,
              'üìç Your location',
              pos.coords.accuracy
            );
          },
          function(err) {
            console.warn('Geolocation error:', err);
            alert("Couldn't get your location. Make sure this page is served over HTTPS (GitHub Pages) or localhost, and allow location permissions.");
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
        );
      } catch (e) {
        console.error('Locate exception:', e);
      }
    }

    function cleanStr(v) {
      if (v === undefined || v === null) return '';
      return ('' + v).trim();
    }

    function searchAddressSafe(query) {
      try {
        var q = cleanStr(query);
        if (!q) return;

        var url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(q);

        fetch(url)
          .then(function(r){ return r.json(); })
          .then(function(results){
            if (!results || !results.length) {
              alert("Couldn't find that location. Try a more specific address.");
              return;
            }
            var hit = results[0];
            var lat = parseFloat(hit.lat);
            var lon = parseFloat(hit.lon);

            if (!isFinite(lat) || !isFinite(lon)) {
              alert('Search returned invalid coordinates.');
              return;
            }

            setUserLocation(lat, lon, hit.display_name);
          })
          .catch(function(err){
            console.error('Geocode fetch error:', err);
            alert('Address search failed. Please try again.');
          });
      } catch (e) {
        console.error('Search exception:', e);
      }
    }

    function addSearchControl() {
      var ctl = L.control({ position: 'bottomleft' });
      ctl.onAdd = function() {
        var div = L.DomUtil.create('div', 'search-ctl');

        div.innerHTML =
          '<button type="button" class="btn-locate">üìç My Location</button>' +
          '<input type="text" class="addr" placeholder="Search address / place" />' +
          '<button type="button" class="btn-go secondary">Go</button>' +
          '<button type="button" class="btn-clear secondary">Clear</button>';

        L.DomEvent.disableClickPropagation(div);
        L.DomEvent.disableScrollPropagation(div);

        var btnLocate = div.querySelector('.btn-locate');
        var btnGo = div.querySelector('.btn-go');
        var btnClear = div.querySelector('.btn-clear');
        var input = div.querySelector('.addr');

        btnLocate.addEventListener('click', function() {
          locateMeSafe();
        });

        btnGo.addEventListener('click', function() {
          searchAddressSafe(input.value);
        });

        btnClear.addEventListener('click', function() {
          clearUserLocation();
          if (input) input.value = '';
        });

        input.addEventListener('keydown', function(e){
          if (e.key === 'Enter') {
            e.preventDefault();
            searchAddressSafe(input.value);
          }
        });

        return div;
      };
      ctl.addTo(map);
    }

    // add it immediately; does not affect CSV pipeline
    addSearchControl();

    // CSVs from repo root (status = live, others = static)
    var CSV_URLS = [
      { url: 'status_latest_slim.csv?v=' + Date.now(),       source: 'live' },
      { url: 'DOT Flo L2 Curbside Chargers.csv',             source: 'flo' },
      { url: 'DOT LOT AND NISSAN CHARGERS (1).csv',          source: 'dot_lot' }
    ];

    function pick(r, keys) {
      for (var i = 0; i < keys.length; i++) {
        var k = keys[i];
        if (r[k] !== undefined && r[k] !== null && r[k] !== '') return r[k];
      }
      return undefined;
    }

    // Normalize to: Available | In Use | Needs Service | Unreachable
    function normalizeToInUse(text) {
      if (!text) return 'Unknown';
      var t = ('' + text).toUpperCase();
      if (t.includes('AVAILABLE')) return 'Available';
      if (t.includes('CHARGING')) return 'In Use';
      if (t.includes('OCCUPIED') || t === 'INUSE') return 'In Use';
      if (t.includes('NEEDS SERVICE') || t.includes('NEED SERVICE')) return 'Needs Service';
      if (t.includes('UNREACHABLE') || t.includes('UNAVAILABLE') || t.includes('DOWN') || t.includes('OFFLINE')) return 'Unreachable';
      return text;
    }

    // Derive final status for a row, prioritizing network status = Unreachable
    function deriveStatus(r) {
      var stationLabel = pick(r, ['station_label']);
      var lastPort     = pick(r, ['LastPortStatus','status']);
      var net          = pick(r, ['StationNetworkStatus','networkStatus','NetworkStatus']);
      var fault        = pick(r, ['faultReason']);

      if (net) {
        var n = ('' + net).toUpperCase();
        if (n.includes('UNREACHABLE') || n.includes('UNAVAILABLE') || n.includes('OFFLINE') || n.includes('DOWN')) {
          return 'Unreachable';
        }
      }

      var base = stationLabel != null && stationLabel !== '' ? stationLabel : lastPort;

      if (fault) {
        var f = ('' + fault).toUpperCase();
        if (f.includes('NEEDS SERVICE') || f.includes('NEED SERVICE')) return 'Needs Service';
      }

      return normalizeToInUse(base);
    }

    function chargerTypeFromRow(r) {
      var v = pick(r, ['Charger type (legend)', 'Charger type']);
      if (!v) return 'Level 2';
      var s = ('' + v).toLowerCase();
      if (s.includes('level 3')) return 'Level 3';
      if (s.includes('solar')) return 'Level 2 Solar';
      return 'Level 2';
    }

    function isPublicStation(r) {
      var legend = pick(r, ['Charger type (legend)']);
      if (!legend) return false;
      var t = ('' + legend).toLowerCase();
      return t.indexOf('public stations') !== -1;
    }

    function classForRow(r) {
      if (r.__source === 'flo') return 'bolt-flo';
      if (r.__source === 'dot_lot') return 'bolt-dotlot';

      if (isPublicStation(r)) return 'bolt-public';
      var ctype = chargerTypeFromRow(r);
      if (ctype === 'Level 3') return 'bolt-l3';
      if (ctype === 'Level 2 Solar') return 'bolt-solar';
      return 'bolt-l2';
    }

    function rowHasCoords(r) {
      var lat = pick(r, ['Lat','lat','Latitude','latitude']);
      var lon = pick(r, ['Long','Longitude','lon','long','Lng','lng','longitude']);
      return (typeof lat === 'number' && typeof lon === 'number' && !isNaN(lat) && !isNaN(lon));
    }

    function classifyRowForLegend(r) {
      if (!rowHasCoords(r)) return null;

      if (r.__source === 'flo') return 'DOT Flo L2';
      if (r.__source === 'dot_lot') return 'DOT LOT';

      if (isPublicStation(r)) return 'Public';
      var ctype = chargerTypeFromRow(r);
      if (ctype === 'Level 3') return 'Level 3';
      if (ctype === 'Level 2 Solar') return 'Level 2 Solar';
      return 'Level 2';
    }

    var allRows = [];
    var markers = [];

    // ‚úÖ Cluster layer instead of a normal layerGroup
    var clusterGroup = L.markerClusterGroup({
      showCoverageOnHover: false,
      spiderfyOnMaxZoom: true,
      disableClusteringAtZoom: 17
    });
    map.addLayer(clusterGroup);

    // Filters
    var filterState = {
      'Available': true,
      'In Use': true,
      'Unreachable': true
    };

    // Type filters
    var typeFilterState = {
      'Public': true,
      'Level 2': true,
      'Level 2 Solar': true,
      'Level 3': true,
      'DOT Flo L2': true,
      'DOT LOT': true
    };

    function passesFilter(statusNorm) {
      if (statusNorm in filterState) return !!filterState[statusNorm];
      return true;
    }

    function passesTypeFilter(r) {
      var bucket = classifyRowForLegend(r);
      if (!bucket) return true;
      if (!(bucket in typeFilterState)) return true;
      return !!typeFilterState[bucket];
    }

    function makePopup(name, statusText, lat, lon, countsHtml, descText) {
      var apple = 'http://maps.apple.com/?daddr=' + lat + ',' + lon;
      var gmaps = 'https://www.google.com/maps/dir/?api=1&destination=' + lat + ',' + lon;

      var popup = '<div style="min-width:220px">'
                + '<strong>' + name + '</strong>'
                + (statusText ? '<br/>Status: ' + statusText : '')
                + (countsHtml ? '<br/>' + countsHtml : '')
                + (descText ? '<br/><b>Rate:</b> ' + descText : '')
                + '<br/><div style="margin-top:6px">'
                + '<a href="' + apple + '" target="_blank" rel="noopener">Directions (Apple)</a> &nbsp;|&nbsp; '
                + '<a href="' + gmaps + '" target="_blank" rel="noopener">Directions (Google)</a>'
                + '</div></div>';
      return popup;
    }

    function boltIconHTML(cls) {
      return '<div class="bolt-circle ' + cls + '">‚ö°</div>';
    }

    function render() {
      clusterGroup.clearLayers();
      markers = [];
      var hasAny = false;

      allRows.forEach(function(r){
        var lat = pick(r, ['Lat','lat','Latitude','latitude']);
        var lon = pick(r, ['Long','Longitude','lon','long','Lng','lng','longitude']);
        if (typeof lat !== 'number' || typeof lon !== 'number' || isNaN(lat) || isNaN(lon)) return;

        var name  = pick(r, [
          'stationName',
          'name',
          'Location',
          'Site',
          'DOT LOT AND NISSAN CHARGERS'
        ]) || r.stationID || 'EV Site';

        var descText = pick(r, ['description', 'Description', 'rate', 'Rate']);

        var statusNorm = deriveStatus(r);
        if (!passesFilter(statusNorm)) return;

        if (!passesTypeFilter(r)) return;

        var cls = classForRow(r);

        var countsHtml = '';
        var pTot = pick(r, ['ports_total']);
        var pA   = pick(r, ['ports_available']);
        var pC   = pick(r, ['ports_charging']) || 0;
        var pO   = pick(r, ['ports_occupied']) || 0;
        var inUse = (typeof pC === 'number' ? pC : parseInt(pC || 0, 10)) +
                    (typeof pO === 'number' ? pO : parseInt(pO || 0, 10));

        if (pTot !== undefined && pTot !== null) {
          var parts = [];
          if (pA !== undefined) parts.push(pA + ' Available');
          parts.push(inUse + ' In Use');
          countsHtml = '<div style="margin-top:6px"><b>Ports:</b> ' + pTot + ' total'
                     + (parts.length ? ' (' + parts.join(' | ') + ')' : '')
                     + '</div>';
        }

        var icon = L.divIcon({
          className: 'bolt-divicon',
          iconSize: [26, 26],
          html: boltIconHTML(cls)
        });

        var marker = L.marker([lat, lon], { icon: icon })
          .bindPopup(makePopup(name, statusNorm, lat, lon, countsHtml, descText));

        clusterGroup.addLayer(marker);
        markers.push(marker);
        hasAny = true;
      });

      if (hasAny) {
        var b = clusterGroup.getBounds();
        if (b && b.isValid()) map.fitBounds(b.pad(0.15));
      }
    }

    var legendControl, legendEl, statusControl;

    function addStatusControl() {
      if (statusControl) return;
      statusControl = L.control({position: 'topright'});
      statusControl.onAdd = function () {
        var div = L.DomUtil.create('div', 'controls');
        div.innerHTML =
          '<b>Filter by Status</b>' +
          '<label><input type="checkbox" data-k="Available" checked/> Available</label>' +
          '<label><input type="checkbox" data-k="In Use" checked/> In Use</label>' +
          '<label><input type="checkbox" data-k="Unreachable" checked/> Unreachable</label>';

        L.DomEvent.disableClickPropagation(div);
        L.DomEvent.disableScrollPropagation(div);

        div.addEventListener('change', function(e){
          var t = e.target;
          if (!t || !t.dataset || !t.dataset.k) return;
          filterState[t.dataset.k] = t.checked;
          render();
        });

        return div;
      };
      statusControl.addTo(map);
    }

    function addLegendTypeControl() {
      if (legendControl) return;
      legendControl = L.control({position: 'topleft'});
      legendControl.onAdd = function () {
        legendEl = L.DomUtil.create('div', 'legend');
        legendEl.innerHTML =
          '<div style="margin-bottom:4px;"><b>Filter by Type</b></div>' +

          '<div class="row">' +
            '<input type="checkbox" data-type="Public" checked style="margin-right:4px;"/>' +
            '<span class="swatch" style="background:#f97316"></span>' +
            '<span class="label">Public</span>' +
            '<span class="count" id="count-public">(0)</span>' +
          '</div>' +

          '<div class="row">' +
            '<input type="checkbox" data-type="Level 2" checked style="margin-right:4px;"/>' +
            '<span class="swatch" style="background:#2563eb"></span>' +
            '<span class="label">Level 2</span>' +
            '<span class="count" id="count-l2">(0)</span>' +
          '</div>' +

          '<div class="row">' +
            '<input type="checkbox" data-type="Level 2 Solar" checked style="margin-right:4px;"/>' +
            '<span class="swatch" style="background:#facc15"></span>' +
            '<span class="label">Level 2 Solar</span>' +
            '<span class="count" id="count-solar">(0)</span>' +
          '</div>' +

          '<div class="row">' +
            '<input type="checkbox" data-type="Level 3" checked style="margin-right:4px;"/>' +
            '<span class="swatch" style="background:#16a34a"></span>' +
            '<span class="label">Level 3</span>' +
            '<span class="count" id="count-l3">(0)</span>' +
          '</div>' +

          '<div class="row">' +
            '<input type="checkbox" data-type="DOT Flo L2" checked style="margin-right:4px;"/>' +
            '<span class="swatch" style="background:#a855f7"></span>' +
            '<span class="label">DOT Flo L2</span>' +
            '<span class="count" id="count-flo">(0)</span>' +
          '</div>' +

          '<div class="row">' +
            '<input type="checkbox" data-type="DOT LOT" checked style="margin-right:4px;"/>' +
            '<span class="swatch" style="background:#6b7280"></span>' +
            '<span class="label">DOT LOT</span>' +
            '<span class="count" id="count-dotlot">(0)</span>' +
          '</div>';

        L.DomEvent.disableClickPropagation(legendEl);
        L.DomEvent.disableScrollPropagation(legendEl);

        legendEl.addEventListener('change', function(e){
          var t = e.target;
          if (!t || !t.dataset || !t.dataset.type) return;
          typeFilterState[t.dataset.type] = t.checked;
          render();
        });

        return legendEl;
      };
      legendControl.addTo(map);
    }

    function updateLegendCounts() {
      if (!legendEl || !allRows) return;

      var counts = {
        'DOT Flo L2': 0,
        'DOT LOT': 0,
        Public: 0,
        'Level 2': 0,
        'Level 2 Solar': 0,
        'Level 3': 0
      };

      allRows.forEach(function(r){
        var bucket = classifyRowForLegend(r);
        if (bucket) counts[bucket] = (counts[bucket] || 0) + 1;
      });

      var byId = function(id){ return legendEl.querySelector('#' + id); };
      var el;

      el = byId('count-public'); if (el) el.textContent = '(' + (counts['Public'] || 0) + ')';
      el = byId('count-l2');     if (el) el.textContent = '(' + (counts['Level 2'] || 0) + ')';
      el = byId('count-solar');  if (el) el.textContent = '(' + (counts['Level 2 Solar'] || 0) + ')';
      el = byId('count-l3');     if (el) el.textContent = '(' + (counts['Level 3'] || 0) + ')';
      el = byId('count-flo');    if (el) el.textContent = '(' + (counts['DOT Flo L2'] || 0) + ')';
      el = byId('count-dotlot'); if (el) el.textContent = '(' + (counts['DOT LOT'] || 0) + ')';
    }

    // Load and merge all CSVs, tagging each row with its source
    var pendingLoads = CSV_URLS.length;
    allRows = [];

    CSV_URLS.forEach(function(cfg) {
      var url = cfg.url;
      var source = cfg.source;

      Papa.parse(url, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(res) {
          if (res && res.data) {
            res.data.forEach(function(row) {
              row.__source = source;
              allRows.push(row);
            });
          }
          pendingLoads--;
          if (pendingLoads === 0) {
            addStatusControl();
            addLegendTypeControl();
            updateLegendCounts();
            render();
          }
        },
        error: function(err){
          console.error('CSV parse error for', url, err);
          pendingLoads--;
        }
      });
    });
  </script>
</body>
</html>
